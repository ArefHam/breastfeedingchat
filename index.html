<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ú¯Ù¾ Ùˆ Ú¯ÙØª Ù…Ø§Ø¯Ø±Ø§Ù†Ù‡ - Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø´ÛŒØ±Ø¯Ù‡ÛŒ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&family=Lalezar&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#fff7fb;
      --bg2:#f1f7ff;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;

      --p1:#a855f7;
      --p2:#8b5cf6;
      --p3:#ec4899;

      --line:#efe6ff;
      --soft:#faf7ff;

      --shadow: 0 18px 55px rgba(88, 28, 135, 0.14);
      --shadow2: 0 10px 25px rgba(17, 24, 39, 0.06);

      --r-lg:22px;
      --r-md:16px;
      --r-sm:12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Vazirmatn', sans-serif;
      direction: rtl;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(168,85,247,0.22), transparent 60%),
        radial-gradient(1000px 500px at 90% 0%, rgba(34,197,94,0.10), transparent 55%),
        radial-gradient(1100px 600px at 60% 110%, rgba(236,72,153,0.12), transparent 60%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      overflow-x: hidden;
    }
    ::selection{ background: rgba(168,85,247,0.25); }

    .header-decoration {
      height: 6px;
      background: linear-gradient(to left, #6fd2ff, #a18aff, #ff9cee);
      border-radius: 0 0 10px 10px;
      box-shadow: 0 8px 20px rgba(168,85,247,0.15);
    }

    .chat-container {
      width: 920px;
      max-width: 95%;
      margin: 22px auto;
      background: rgba(255,255,255,0.80);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(239,230,255,0.9);
      min-height: 90vh;
      position: relative;
    }

    .chat-container::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: linear-gradient(180deg, rgba(168,85,247,0.10), transparent 22%, transparent 78%, rgba(34,197,94,0.06));
      opacity: 0.8;
    }

    .chat-header {
      background:
        radial-gradient(700px 180px at 30% 20%, rgba(255,255,255,0.18), transparent 60%),
        linear-gradient(135deg, var(--p1) 0%, var(--p2) 45%, rgba(34,197,94,0.18) 140%);
      color: #fff;
      padding: 18px 18px 16px;
      text-align: center;
      font-family: 'Lalezar', cursive;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      z-index: 1;
      border-bottom: 1px solid rgba(255,255,255,0.12);
    }
    .chat-header::after{
      content:"";
      position:absolute;
      bottom:0; left:0; right:0;
      height: 1px;
      background: linear-gradient(to left, rgba(255,255,255,0.35), rgba(255,255,255,0.08), rgba(255,255,255,0.35));
      opacity: 0.9;
    }
    .chat-header i {
      font-size: 26px;
      opacity: 0.95;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,0.12));
    }
    .chat-header > div{ line-height: 1.2; }
    .chat-header > div:first-child{ font-size: 26px; letter-spacing: 0.2px; }
    .header-subtitle {
      font-size: 14px;
      font-weight: 400;
      margin-top: 6px;
      opacity: 0.92;
      font-family: 'Vazirmatn', sans-serif;
    }

    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 12px 14px 8px;
      background: rgba(252,250,255,0.92);
      border-bottom: 1px solid rgba(239,230,255,0.8);
      z-index: 1;
    }
    .quick-btn {
      padding: 10px 14px;
      background:
        radial-gradient(240px 100px at 20% 20%, rgba(255,255,255,0.60), transparent 60%),
        linear-gradient(135deg, rgba(243,232,255,0.95) 0%, rgba(237,233,254,0.92) 55%, rgba(240,249,255,0.75) 120%);
      border: 1px solid rgba(221,214,254,0.75);
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      color: #5b21b6;
      transition: 0.18s ease;
      font-family: 'Vazirmatn', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 18px rgba(17,24,39,0.05);
    }
    .quick-btn i{ color: rgba(168,85,247,0.95); }
    .quick-btn:hover { transform: translateY(-2px); border-color: rgba(168,85,247,0.45); }

    .chat-box {
      flex: 1;
      height: 520px;
      overflow-y: auto;
      padding: 20px 16px 22px 18px;
      background:
        radial-gradient(700px 260px at 80% 0%, rgba(168,85,247,0.08), transparent 60%),
        radial-gradient(700px 260px at 10% 100%, rgba(34,197,94,0.06), transparent 60%),
        var(--soft);
      display: flex;
      flex-direction: column;
      gap: 14px;
      overflow-x: hidden;
      z-index: 1;
    }

    .welcome-message {
      background:
        radial-gradient(500px 200px at 20% 0%, rgba(168,85,247,0.14), transparent 60%),
        linear-gradient(135deg, #eef2ff 0%, #fff1fb 60%, #f5fffb 140%);
      padding: 18px 18px;
      border-radius: var(--r-md);
      margin-bottom: 12px;
      border-right: 6px solid var(--p1);
      text-align: center;
      box-shadow: var(--shadow2);
    }
    .welcome-title {
      font-size: 20px;
      color: #6d28d9;
      margin-bottom: 10px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .welcome-text { color: #4b5563; line-height: 1.85; font-size: 15px; }

    .message {
      margin: 5px 0;
      padding: 14px 16px;
      border-radius: 18px;
      max-width: 78%;
      word-wrap: break-word;
      box-shadow: 0 10px 24px rgba(17,24,39,0.06);
      position: relative;
      animation: fadeIn 0.25s ease-in-out;
      border: 1px solid transparent;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-message {
      background:
        radial-gradient(400px 140px at 30% 20%, rgba(255,255,255,0.18), transparent 60%),
        linear-gradient(135deg, var(--p1) 0%, var(--p2) 80%);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 6px;
      text-align: right;
      margin-right: 44px;
      border: 1px solid rgba(255,255,255,0.12);
    }
    .bot-message {
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(233,213,255,0.95);
      margin-right: auto;
      border-bottom-left-radius: 6px;
      margin-left: 44px;
      box-shadow: 0 12px 28px rgba(88, 28, 135, 0.08);
    }

    .bot-message::before {
      content: "ğŸ¤±";
      position: absolute;
      left: -48px;
      top: 14px;
      font-size: 21px;
      background: rgba(243,232,255,0.95);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 20px rgba(168,85,247,0.14);
      border: 1px solid rgba(233,213,255,0.9);
    }
    .user-message::after {
      content: "ğŸ’¬";
      position: absolute;
      right: -48px;
      top: 14px;
      font-size: 21px;
      background: rgba(237,233,254,0.95);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 20px rgba(139,92,246,0.16);
      border: 1px solid rgba(221,214,254,0.9);
    }

    .message-text {
      font-size: 16px;
      line-height: 1.95;
      word-break: break-word;
      letter-spacing: 0.1px;
    }
    .message-text strong{ font-weight: 800; }

    /* multilingual correctness */
    .msg-rtl { direction: rtl; text-align: right; }
    .msg-ltr { direction: ltr; text-align: left; }

    /* exact rendering container */
    .rendered-answer {
      unicode-bidi: plaintext;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }

    /* âœ… Typewriter look */
    .typing-caret {
      display: inline-block;
      width: 10px;
      margin-inline-start: 2px;
      opacity: 0.9;
      animation: caretBlink 0.9s infinite;
      color: rgba(109,40,217,0.95);
      font-weight: 800;
    }
    @keyframes caretBlink { 0%,49%{opacity:1} 50%,100%{opacity:0} }

    .message-time {
      font-size: 12px;
      opacity: 0.75;
      margin-top: 9px;
      color: rgba(75,85,99,0.8);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-message .message-time { color: rgba(255,255,255,0.92); justify-content: flex-start; }
    .bot-message .message-time  { justify-content: flex-end; }

    .pill {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(233,213,255,0.9);
      background: rgba(243,232,255,0.7);
      color: #6d28d9;
    }
    .pill.ok { border-color: rgba(34,197,94,0.25); background: rgba(34,197,94,0.10); color: #166534; }
    .pill.warn { border-color: rgba(249,115,22,0.25); background: rgba(249,115,22,0.10); color: #9a3412; }

    .input-area {
      display: flex;
      gap: 10px;
      padding: 16px 16px 18px;
      border-top: 1px solid rgba(239,230,255,0.95);
      background: linear-gradient(180deg, rgba(252,250,255,0.96) 0%, rgba(250,247,255,0.92) 100%);
      z-index: 1;
    }
    input {
      flex: 1;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid rgba(221,221,221,0.9);
      font-size: 16px;
      font-family: 'Vazirmatn', sans-serif;
      transition: all 0.25s;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 8px 18px rgba(17,24,39,0.04);
    }
    input:focus {
      outline: none;
      border-color: rgba(168,85,247,0.75);
      box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.18);
      transform: translateY(-1px);
    }

    button {
      padding: 14px 18px;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      font-size: 15px;
      transition: 0.22s ease;
      font-family: 'Vazirmatn', sans-serif;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 10px 22px rgba(17,24,39,0.07);
      user-select: none;
    }
    button#send-btn {
      background: radial-gradient(300px 120px at 20% 20%, rgba(255,255,255,0.18), transparent 60%),
                  linear-gradient(135deg, var(--p1) 0%, var(--p2) 85%);
      color: #fff;
    }
    button#send-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 28px rgba(168, 85, 247, 0.25); }
    button#clear-btn {
      background: radial-gradient(260px 110px at 20% 20%, rgba(255,255,255,0.18), transparent 60%),
                  linear-gradient(135deg, #fb923c 0%, #f97316 75%, #ea580c 120%);
      color: #fff;
    }
    button#clear-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 28px rgba(249, 115, 22, 0.22); }
    button:disabled{ opacity: 0.6; cursor: not-allowed; transform: none !important; filter: none !important; box-shadow: none !important; }

    .footer-info {
      text-align: center;
      padding: 13px 16px;
      font-size: 13px;
      color: rgba(75,85,99,0.9);
      background: linear-gradient(180deg, rgba(248,245,255,0.95) 0%, rgba(255,255,255,0.90) 100%);
      border-top: 1px solid rgba(239,230,255,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 18px;
      flex-wrap: wrap;
      z-index: 1;
    }
    .footer-info i { color: rgba(168,85,247,0.95); }

    .typing-indicator {
      display: flex;
      padding: 14px 14px;
      background: linear-gradient(135deg, rgba(243,232,255,0.95) 0%, rgba(240,249,255,0.88) 100%);
      border: 1px solid rgba(233,213,255,0.9);
      border-radius: 18px;
      width: fit-content;
      margin-right: auto;
      margin-left: 44px;
      align-items: center;
      gap: 10px;
      min-width: 160px;
      box-shadow: 0 12px 22px rgba(88, 28, 135, 0.08);
    }
    .typing-text { color: #6d28d9; font-size: 14px; font-weight: 600; }
    .typing-dots { display: flex; gap: 6px; }
    .typing-dots span {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: linear-gradient(180deg, rgba(168,85,247,0.95), rgba(139,92,246,0.9));
      animation: dots 1.4s infinite ease-in-out;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dots { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-8px)} }

    @media (max-width: 768px) {
      .chat-container { margin: 10px auto; border-radius: 18px; }
      .chat-box { height: 450px; padding: 14px 10px 18px 12px; }
      .message { max-width: 88%; margin-right: 0 !important; margin-left: 0 !important; }
      .input-area { flex-direction: column; padding: 14px; }
      button { width: 100%; }
      .quick-actions { justify-content: center; }
      .footer-info { flex-direction: column; gap: 10px; }
    }
  </style>
</head>

<body>
  <div class="header-decoration"></div>

  <div class="chat-container">
    <div class="chat-header">
      <i class="fas fa-heart"></i>
      <div>
        Ú¯Ù¾ Ùˆ Ú¯ÙØª Ù…Ø§Ø¯Ø±Ø§Ù†Ù‡
        <div class="header-subtitle">Ù¾Ø±Ø³Ø´ Ùˆ Ù¾Ø§Ø³Ø® ØªØ®ØµØµÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø´ÛŒØ±Ø¯Ù‡ÛŒ Ùˆ Ù…Ø±Ø§Ù‚Ø¨Øª Ø§Ø² Ù†ÙˆØ²Ø§Ø¯</div>
      </div>
      <i class="fas fa-baby"></i>
    </div>

    <div class="quick-actions">
      <button class="quick-btn" data-question="Ù…Ø´Ú©Ù„Ø§Øª Ø´ÛŒØ±Ø¯Ù‡ÛŒ Ú†ÛŒØ³ØªØŸ"><i class="fas fa-question-circle"></i> Ù…Ø´Ú©Ù„Ø§Øª Ø´ÛŒØ±Ø¯Ù‡ÛŒ</button>
      <button class="quick-btn" data-question="ÙÙˆØ§ÛŒØ¯ Ø´ÛŒØ± Ù…Ø§Ø¯Ø± Ú†ÛŒØ³ØªØŸ"><i class="fas fa-heartbeat"></i> ÙÙˆØ§ÛŒØ¯ Ø´ÛŒØ± Ù…Ø§Ø¯Ø±</button>
      <button class="quick-btn" data-question="Ø±Ø§Ù‡Ù‡Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø´ÛŒØ± Ù…Ø§Ø¯Ø± Ú†ÛŒØ³ØªØŸ"><i class="fas fa-plus-circle"></i> Ø§ÙØ²Ø§ÛŒØ´ Ø´ÛŒØ±</button>
      <button class="quick-btn" data-question="ØªØºØ°ÛŒÙ‡ Ù…Ø§Ø¯Ø± Ø´ÛŒØ±Ø¯Ù‡"><i class="fas fa-apple-alt"></i> ØªØºØ°ÛŒÙ‡ Ù…Ø§Ø¯Ø±</button>
      <button class="quick-btn" data-question="How can I tell if my baby is getting enough milk while breastfeeding?"><i class="fas fa-language"></i> English test</button>
      <button class="quick-btn" data-question="ÙƒÙŠÙ Ø£Ø¹Ø±Ù Ø£Ù† Ø·ÙÙ„ÙŠ ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø§ ÙŠÙƒÙÙŠ Ù…Ù† Ø§Ù„Ø­Ù„ÙŠØ¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¶Ø§Ø¹Ø©ØŸ"><i class="fas fa-language"></i> Arabic test</button>
    </div>

    <div id="chat-box" class="chat-box">
      <div class="welcome-message">
        <div class="welcome-title">
          <i class="fas fa-hands-helping"></i>
          Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ù…Ø§Ø¯Ø± Ø¹Ø²ÛŒØ²!
          <i class="fas fa-hands-helping"></i>
        </div>
        <div class="welcome-text">
          Ø§ÛŒÙ†Ø¬Ø§ ÙØ¶Ø§ÛŒÛŒ Ø§Ù…Ù† Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø³Ø´â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø´ÛŒØ±Ø¯Ù‡ÛŒ Ùˆ Ù…Ø±Ø§Ù‚Ø¨Øª Ø§Ø² Ù†ÙˆØ²Ø§Ø¯ Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³ÙˆØ§Ù„Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø·Ø±Ø­ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ø¨Ø§Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…Ø§ÛŒÛŒØ¯.
        </div>
      </div>
    </div>

    <div class="input-area">
      <input id="user-input" type="text" placeholder="Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø´ÛŒØ±Ø¯Ù‡ÛŒØŒ ØªØºØ°ÛŒÙ‡ Ù†ÙˆØ²Ø§Ø¯ ÛŒØ§ Ù…Ø±Ø§Ù‚Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø³ Ø§Ø² Ø²Ø§ÛŒÙ…Ø§Ù† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." />
      <button id="send-btn"><i class="fas fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„</button>
      <button id="clear-btn"><i class="fas fa-trash-alt"></i> Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù†</button>
    </div>

    <div class="footer-info">
      <div><i class="fas fa-shield-alt"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯</div>
      <div><i class="fas fa-users"></i> Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ ØªÙˆØ³Ø· Ù…Ø´Ø§ÙˆØ±Ø§Ù† Ø´ÛŒØ±Ø¯Ù‡ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</div>
      <div><i class="fas fa-clock"></i> Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Û²Û´ Ø³Ø§Ø¹ØªÙ‡</div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const N8N_WEBHOOK_URL = "https://n8n.eveai.cloud/webhook/1b006acc-f062-4f5f-ab6b-99185f903b75";

      const sendBtn = document.getElementById("send-btn");
      const clearBtn = document.getElementById("clear-btn");
      const input = document.getElementById("user-input");
      const quickButtons = document.querySelectorAll(".quick-btn");
      const chatBox = document.getElementById("chat-box");

      // ---------- Utilities ----------
      function scrollToBottom() { chatBox.scrollTop = chatBox.scrollHeight; }

      function escapeHTML(str) {
        return String(str).replace(/[&<>"'`=\/]/g, (s) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
          "`": "&#x60;",
          "=": "&#x3D;",
          "/": "&#x2F;"
        })[s]);
      }

      // Apply markdown-lite AFTER typing finishes (so typing stays faithful)
      function renderMarkdownLiteToHTML(rawText) {
        const text = (rawText == null) ? "" : String(rawText);
        let safe = escapeHTML(text);
        safe = safe.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        safe = safe.replace(/\r\n/g, "\n").replace(/\n/g, "<br>");
        return safe;
      }

      function detectDir(text) {
        const s = (text == null) ? "" : String(text);
        const rtlRe = /[\u0591-\u07FF\uFB1D-\uFDFD\uFE70-\uFEFC]/;
        const ltrRe = /[A-Za-z]/;
        for (const ch of s) {
          if (/\s/.test(ch)) continue;
          if (rtlRe.test(ch)) return "rtl";
          if (ltrRe.test(ch)) return "ltr";
        }
        return document.documentElement.dir || "rtl";
      }

      function getOrCreateSessionId() {
        let sessionId = localStorage.getItem("eveai_sessionId");
        if (!sessionId) {
          sessionId = (crypto && crypto.randomUUID)
            ? crypto.randomUUID()
            : (Date.now() + "_" + Math.random().toString(16).slice(2));
          localStorage.setItem("eveai_sessionId", sessionId);
        }
        return sessionId;
      }

      function createTypingIndicator() {
        const typingDiv = document.createElement("div");
        typingDiv.className = "typing-indicator";
        typingDiv.innerHTML = `
          <div class="typing-text">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø®...</div>
          <div class="typing-dots"><span></span><span></span><span></span></div>
        `;
        return typingDiv;
      }

      function timeHHMM() {
        const t = new Date();
        return `${t.getHours().toString().padStart(2, "0")}:${t.getMinutes().toString().padStart(2, "0")}`;
      }

      function pillHTML(label, cls) {
        return `<span class="pill ${cls || ""}">${escapeHTML(label)}</span>`;
      }

      // ---------- Typewriter (multilingual-safe) ----------
      function computeTypingSpeedMs(text) {
        const len = (text || "").length;
        // Short answers: slower (feels human). Long answers: faster (avoid boredom).
        if (len <= 300) return 18;
        if (len <= 900) return 10;
        return 6;
      }

      async function typeTextInto(preEl, fullText, { baseSpeedMs = 10, maxDurationMs = 9000 } = {}) {
        // We type the RAW text (no HTML), preserving fidelity.
        // We keep newlines by using a <pre> or white-space: pre-wrap.
        preEl.textContent = "";
        let i = 0;

        // Cap total duration to avoid 2-minute typing for long texts.
        const len = fullText.length || 1;
        const estimated = len * baseSpeedMs;
        const speed = (estimated > maxDurationMs) ? Math.max(2, Math.floor(maxDurationMs / len)) : baseSpeedMs;

        return new Promise(resolve => {
          function tick() {
            if (i >= fullText.length) return resolve();

            const ch = fullText.charAt(i);
            preEl.textContent += ch;
            i++;

            // Micro-pauses for more natural feel (doesn't change content)
            let s = speed;
            if (ch === "\n") s = speed * 8;
            else if (/[.!ØŸ]/.test(ch)) s = speed * 10;
            else if (/[,:Ø›]/.test(ch)) s = speed * 6;
            else if (ch === " ") s = Math.max(1, Math.floor(speed * 0.7));

            scrollToBottom();
            setTimeout(tick, s);
          }
          tick();
        });
      }

      // ---------- Message creation ----------
      function addMessage({ text, sender, metaPills = [], typing = false }) {
        const container = document.createElement("div");
        container.className = "message " + (sender === "user" ? "user-message" : "bot-message");

        const msgText = document.createElement("div");
        msgText.className = "message-text";

        if (sender === "user") {
          msgText.textContent = (text == null) ? "" : String(text);
          container.classList.add("msg-rtl");
          container.appendChild(msgText);
        } else {
          const dir = detectDir(text);
          container.classList.add(dir === "ltr" ? "msg-ltr" : "msg-rtl");

          if (!typing) {
            // instant render (HTML-safe, markdown-lite)
            msgText.innerHTML = `<div class="rendered-answer">${renderMarkdownLiteToHTML(text)}</div>`;
            container.appendChild(msgText);
          } else {
            // typing mode: render raw text in a pre-like div + caret
            const wrap = document.createElement("div");
            wrap.className = "rendered-answer";

            const pre = document.createElement("div");
            pre.style.whiteSpace = "pre-wrap";
            pre.style.unicodeBidi = "plaintext";
            pre.style.overflowWrap = "anywhere";

            const caret = document.createElement("span");
            caret.className = "typing-caret";
            caret.textContent = "â–";

            wrap.appendChild(pre);
            wrap.appendChild(caret);

            msgText.appendChild(wrap);
            container.appendChild(msgText);

            // return handles so we can type into it
            container.__typing = { pre, caret, rawText: String(text || "") };
          }
        }

        const timeDiv = document.createElement("div");
        timeDiv.className = "message-time";
        if (sender === "bot" && metaPills.length) {
          timeDiv.innerHTML = metaPills.map(p => pillHTML(p.label, p.cls)).join(" ");
        } else {
          timeDiv.textContent = timeHHMM();
        }
        container.appendChild(timeDiv);

        chatBox.appendChild(container);
        scrollToBottom();

        return container;
      }

      // ---------- Robust response extraction ----------
      function extractAnswer(data) {
        const candidate =
          (data && (data.answer ?? data.response ?? data.text ?? data.output)) ??
          (Array.isArray(data) ? (data[0]?.answer ?? data[0]?.response ?? data[0]?.text ?? data[0]?.output) : null);

        if (candidate == null) return null;
        if (typeof candidate === "string") return candidate;

        if (typeof candidate === "object") {
          if (typeof candidate.answer === "string") return candidate.answer;
          if (typeof candidate.output === "string") return candidate.output;
          try { return JSON.stringify(candidate, null, 2); } catch { return String(candidate); }
        }
        return String(candidate);
      }

      // ---------- Networking ----------
      async function fetchWithTimeout(url, options, timeoutMs) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeoutMs);
        try {
          return await fetch(url, { ...options, signal: controller.signal });
        } finally {
          clearTimeout(id);
        }
      }

      async function postToN8n(msg, sessionId) {
        const started = performance.now();
        const res = await fetchWithTimeout(
          N8N_WEBHOOK_URL,
          {
            method: "POST",
            headers: { "Content-Type": "application/json", "Accept": "application/json" },
            body: JSON.stringify({ msg, sessionId })
          },
          120000
        );

        const latencyMs = Math.round(performance.now() - started);

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status} ${res.statusText} :: ${txt.slice(0, 200)}`);
        }

        const data = await res.json();
        return { data, latencyMs };
      }

      // ---------- Main send logic ----------
      let isSending = false;

      async function sendMessage() {
        if (isSending) return;

        const msg = input.value.trim();
        if (!msg) return;

        addMessage({ text: msg, sender: "user" });
        input.value = "";
        input.focus();

        const typingIndicator = createTypingIndicator();
        chatBox.appendChild(typingIndicator);
        scrollToBottom();

        isSending = true;
        sendBtn.disabled = true;
        input.disabled = true;

        try {
          const sessionId = getOrCreateSessionId();
          const { data, latencyMs } = await postToN8n(msg, sessionId);

          if (typingIndicator && typingIndicator.parentNode) typingIndicator.parentNode.removeChild(typingIndicator);

          const answer = extractAnswer(data);
          if (!answer) {
            addMessage({ text: "Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.", sender: "bot", metaPills: [{label:"Invalid", cls:"warn"}] });
            console.log("Raw n8n response:", data);
            return;
          }

          const pill = latencyMs < 8000
            ? { label: `â± ${latencyMs}ms`, cls: "ok" }
            : { label: `â± ${Math.round(latencyMs/1000)}s`, cls: "warn" };

          // âœ… Create bot message in typing mode
          const botMsg = addMessage({
            text: answer,
            sender: "bot",
            metaPills: [pill, { label: timeHHMM(), cls: "" }],
            typing: true
          });

          // âœ… Run typewriter safely
          const t = botMsg.__typing;
          const speed = computeTypingSpeedMs(t.rawText);

          await typeTextInto(t.pre, t.rawText, { baseSpeedMs: speed, maxDurationMs: 9000 });

          // After typing, replace with HTML-safe markdown-lite rendering (bold + <br>)
          // This keeps fidelity and improves readability.
          botMsg.querySelector(".message-text").innerHTML =
            `<div class="rendered-answer">${renderMarkdownLiteToHTML(t.rawText)}</div>`;

        } catch (err) {
          if (typingIndicator && typingIndicator.parentNode) typingIndicator.parentNode.removeChild(typingIndicator);
          addMessage({ text: "Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.", sender: "bot", metaPills: [{label:"Error", cls:"warn"}] });
          console.error(err);
        } finally {
          isSending = false;
          sendBtn.disabled = false;
          input.disabled = false;
        }
      }

      // ---------- Clear behavior ----------
      clearBtn.addEventListener("click", function () {
        if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú¯ÙØªÚ¯Ùˆ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;

        const messages = chatBox.querySelectorAll(".message");
        messages.forEach(m => m.remove());

        localStorage.removeItem("eveai_sessionId");

        addMessage({ text: "Ú¯ÙØªÚ¯Ùˆ Ù¾Ø§Ú© Ø´Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø³ÙˆØ§Ù„ Ø¨Ù¾Ø±Ø³ÛŒØ¯.", sender: "bot", metaPills: [{label:"Cleared", cls:"ok"}] });
      });

      // ---------- Events ----------
      sendBtn.addEventListener("click", sendMessage);
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") sendMessage();
      });

      quickButtons.forEach(button => {
        button.addEventListener("click", function () {
          const question = this.getAttribute("data-question") || "";
          input.value = question;
          sendMessage();
        });
      });
    });
  </script>
</body>
</html>
